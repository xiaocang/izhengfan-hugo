{{- $cf := .Site.Params.comments.cloudflare -}}
{{- if $cf.turnstile -}}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{{- end -}}
<script type="text/javascript">
(function() {
    var workerUrl = '{{ $cf.workerUrl }}';
    var pageUrl = '{{ .Permalink }}';
    var turnstileEnabled = {{ if $cf.turnstile }}true{{ else }}false{{ end }};
    var turnstileSiteKey = '{{ $cf.turnstileSiteKey }}';
    var turnstileWidgetId = null;
    var avatarBase = '{{ $cf.avatarBase | default "" }}';
    var avatarSize = {{ $cf.avatarSize | default 48 }};
    var avatarDefault = '{{ $cf.avatarDefault | default "identicon" }}';
    var avatarFallback = '{{ "img/avatar.gif" | relURL }}';

    // i18n strings
    var lang = '{{ .Site.Language.Lang | default "zh" }}';
    var i18n = {
        noComments: '{{ i18n "no_comments" }}',
        loadFailed: '{{ i18n "load_comments_failed" }}',
        fillRequired: '{{ i18n "fill_required" }}',
        completeCaptcha: '{{ i18n "complete_captcha" }}',
        submitting: '{{ i18n "submitting" }}',
        submitSuccess: '{{ i18n "comment_success" }}',
        submitFailed: '{{ i18n "submit_failed" }}',
        submitComment: '{{ i18n "submit_comment" }}'
    };

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        var d = new Date(dateStr);
        return d.toLocaleDateString(lang) + ' ' + d.toLocaleTimeString(lang, {hour: '2-digit', minute: '2-digit'});
    }

    function normalizeAvatarBase(base) {
        if (!base) return '';
        if (base.charAt(base.length - 1) !== '/') return base + '/';
        return base;
    }

    function resolveAvatarBase() {
        if (avatarBase) return normalizeAvatarBase(avatarBase);
        if (!workerUrl) return '';
        var trimmed = workerUrl.replace(/\/+$/, '');
        if (!trimmed) return '';
        return trimmed + '/avatar/by-id/';
    }

    var avatarBaseNormalized = resolveAvatarBase();

    function buildAvatarUrl(key) {
        if (!key || !avatarBaseNormalized) return avatarFallback;
        var url = avatarBaseNormalized + key;
        var params = [];
        if (avatarSize) params.push('s=' + encodeURIComponent(avatarSize));
        if (avatarDefault) params.push('d=' + encodeURIComponent(avatarDefault));
        if (params.length > 0) url += '?' + params.join('&');
        return url;
    }

    function resolveAvatarKey(comment) {
        if (comment.id !== undefined && comment.id !== null) {
            return String(comment.id);
        }
        return '';
    }

    function renderComments(comments) {
        var list = document.getElementById('cf-comments-list');
        if (!comments || comments.length === 0) {
            list.innerHTML = '<p class="cf-no-comments">' + i18n.noComments + '</p>';
            return;
        }
        var html = '<ul class="cf-comments-ul">';
        comments.forEach(function(c) {
            var avatarKey = resolveAvatarKey(c);
            var avatarUrl = buildAvatarUrl(avatarKey);
            var avatarAlt = c.name ? 'Avatar for ' + c.name : 'Avatar';
            html += '<li class="cf-comment">' +
                '<div class="cf-comment-avatar">' +
                '<img src="' + avatarUrl + '" alt="' + escapeHtml(avatarAlt) + '" loading="lazy">' +
                '</div>' +
                '<div class="cf-comment-body">' +
                '<div class="cf-comment-meta">' +
                '<strong>' + escapeHtml(c.name) + '</strong>' +
                '<span class="cf-comment-date">' + formatDate(c.created_at || c.createdAt) + '</span>' +
                '</div>' +
                '<div class="cf-comment-content">' + escapeHtml(c.content) + '</div>' +
                '</div>' +
                '</li>';
        });
        html += '</ul>';
        list.innerHTML = html;
    }

    function fetchComments() {
        fetch(workerUrl + '/comments?url=' + encodeURIComponent(pageUrl))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                renderComments(data.comments || data);
            })
            .catch(function(err) {
                console.error('Failed to fetch comments:', err);
                document.getElementById('cf-comments-list').innerHTML = '<p class="cf-error">' + i18n.loadFailed + '</p>';
            });
    }

    function submitComment(e) {
        e.preventDefault();
        var btn = document.getElementById('cf-submit-btn');
        var status = document.getElementById('cf-form-status');
        var name = document.getElementById('cf-name').value.trim();
        var email = document.getElementById('cf-email').value.trim();
        var content = document.getElementById('cf-content').value.trim();

        if (!name || !content) {
            status.innerHTML = '<span class="cf-error">' + i18n.fillRequired + '</span>';
            return;
        }

        var body = {
            url: pageUrl,
            name: name,
            email: email,
            content: content
        };

        if (turnstileEnabled && turnstileWidgetId) {
            var token = turnstile.getResponse(turnstileWidgetId);
            if (!token) {
                status.innerHTML = '<span class="cf-error">' + i18n.completeCaptcha + '</span>';
                return;
            }
            body.turnstileToken = token;
        }

        btn.disabled = true;
        btn.textContent = i18n.submitting;
        status.innerHTML = '';

        fetch(workerUrl + '/comments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(function(res) {
            if (!res.ok) throw new Error('Submit failed');
            return res.json();
        })
        .then(function() {
            status.innerHTML = '<span class="cf-success">' + i18n.submitSuccess + '</span>';
            document.getElementById('cf-comment-form').reset();
            if (turnstileEnabled && turnstileWidgetId) {
                turnstile.reset(turnstileWidgetId);
            }
            fetchComments();
        })
        .catch(function(err) {
            console.error('Failed to submit comment:', err);
            status.innerHTML = '<span class="cf-error">' + i18n.submitFailed + '</span>';
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = i18n.submitComment;
        });
    }

    function loadComments() {
        fetchComments();
        document.getElementById('cf-comment-form').addEventListener('submit', submitComment);

        if (turnstileEnabled && turnstileSiteKey) {
            turnstileWidgetId = turnstile.render('.cf-turnstile', {
                sitekey: turnstileSiteKey
            });
        }
    }

    $(document).ready(function() {
        loadComments();
    });
})();
</script>
<noscript>{{ i18n "enable_js_comments" }}</noscript>
